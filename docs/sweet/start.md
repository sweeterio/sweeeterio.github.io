# Sweet 小试牛刀

## 背景

SonarQube 是一款代码扫描平台，我们也使用几年有余。当初为了能够平滑推广，只保留 bug 和缺陷类型的规则，关闭了所有坏味道规则。

最近，我们开始从 SonarQube7.9 升级到 8.9，而且打开了坏味道规则。结果扫描发现历史遗留的坏味道问题数量巨大，修复时间无法承受，经过沟通决定历史遗留的坏味道问题一次性关闭，之后新产生的才做修复。

是的，把现在扫描出来的坏味道问题全部关闭，本来以为是很简单的操作，结果我去操作的时候发现，在 SonarQube 上一次只能关闭500个问题，如果我们有5百万级别的坏味道，那可能要手工操作10000次！每次操作最快10秒，不间断操作总共需要28小时！

是可忍孰不可忍！要不是我有 Sweet，恐怕真的要哭了，今天我就用 Sweet 这把牛刀杀杀坏味道这只鸡。

## 一、用例需求分析

![SonarQube](../_media/SonarQube.gif)

1. 打开 SonarQube 首页
2. 登录
3. 点击导航栏的[问题]
4. 点击问题类型[异味]
5. 点击[全部选择]
6. 点击[批量修改]
7. 在弹出框中，选择[标记为不会修复]
8. 在[评论框]中输入评论内容
9. 点击[应用]，等待修改完成
10. 检查[批量修改]状态复原

## 二、用例编写

### 1. 快速编写

#### 初始化模板

- 复制 baidu.xlsx 一份，改名为 SonarQube.xlsx
- 将测试用例 sheet 面的用例部分删除，只保留标题行
- 将元素列表 sheet 面，除了 public 部分，其他内容删除
- 删除测试数据和一次性测试数据 sheet 页

#### 定义元素列表

```shell
app: SonarQube                                       # 自定义的名称
module: web                                          # 测试的是 Web 页面，需要使用 Web 关键字模块）
setting: {'browserName': 'Chrome','headless': False} # 启动配置
```

如下表：

| app       | element     | value                                                 | by                |
|-----------|-------------|-------------------------------------------------------|-------------------|
| SonarQube | module      | web                                                   |                   |
|           | setting     | {'browserName': 'Chrome','headless': False}           | json              |

#### 编写用例

为了快速，我们尽量使用 public 中已经定义好的变量定位方式来写元素，如步骤2的 id#login

|用例编号           | 用例标题         | 前置条件 | 测试步骤 | 应用 | 操作  | 元素                 | 测试数据                |
| ---------------- | ---------------- | ------- | ------- | ---- | ---- | -------------------- | ---------------------- |
| home_001         | 登录SonarQube    |         | 1        |      | 打开  | `url#sonarqube.io`  | #tab=SonarQube         |  
|                  |                  |         | 2       |      | 输入  | `id#login`           | admin                  |
|                  |                  |         | 3       |      | 输入  | `id#password`       | 123456                 |
|                  |                  |         | 4       |      | 点击  | 登录按钮             |                        |
|                  |                  |         | 5        |     | 点击  | 问题页               |                        |
|                  |                  |         | 6        |     | 点击  | 异味                 |                        |
| change_001       | 批量修改为不会修复 |         | 1        |     | 点击  | 选择所有问题          |                        |
|                  |                  |         | 2       |     | 检查  | 批量修改              | 批量修改 500 个问题     |
|                  |                  |         | 3       |     | 点击  | 批量修改              |                        |
|                  |                  |         | 4       |     | 点击  | 标记为不会修复         |                   |
|                  |                  |         | 5       |     | 输入  | 评论                  | 历史遗留问题，不做修复    |
|                  |                  |         | 6       |     | 点击  | 应用                  |                         |
|                  |                  |         | 7       |     | 检查  | 批量修改              | 批量修改, #wait=8       |

其中，部分元素在元素列表中定义，value 直接 F12 复制 xpath 即可，如下表展示部分定义：

| app       | element     | value                                                 | by                |
|-----------|-------------|-------------------------------------------------------|-------------------|
| SonarQube | module      | web                                                   |                   |
|           | setting     | {'browserName': 'Chrome','headless': False}           | json              |
|           | 登录按钮     | //*[@id="login_form"]/form/div[3]/div/button          | xpath             |
|           | 问题页       | //*[@id="global-navigation"]/div/div/ul[1]/li[2]/a         | xpath             |
|           | 异味         | //*[@id="issues-page"]/div[1]/section/div/div/div[3]//span | xpath             |

### 2. 添加循环执行

我们希望用例批量修改部分可以循环10000次，那么就需要用到用例组合的循环执行功能

- 首先，我们要定义个用例组合，只需要将用例编号 change_001 改为 notfix#change_001 即可，这样 smell_001 就放到了 notfix 用例组合里
- 然后加一条用例，循环执行用例组合 notfix，如下表所示

|用例编号           | 用例标题         | 前置条件 | 测试步骤 | 应用 | 操作  | 元素                 | 测试数据                |
| ---------------- | ---------------- | ------- | ------- | ---- | ---- | -------------------- | ---------------------- |
| home_001         | 登录SonarQube    |         | 1        |      | 打开  | `url#sonarqube.io`  | #tab=SonarQube         |  
|                  |                  |         | 2       |      | 输入  | `id#login`           | admin                  |
|                  |                  |         | 3       |      | 输入  | `id#password`       | 123456                 |
|                  |                  |         | 4       |      | 点击  | 登录按钮             |                        |
|                  |                  |         | 5        |     | 点击  | 问题页               |                        |
|                  |                  |         | 6        |     | 点击  | 异味                 |                        |
| `notfix#change_001` | 批量修改为不会修复 |      | 1        |     | 点击  | 选择所有问题          |                        |
|                  |                  |         | 2       |     | 检查  | 批量修改              | 批量修改 500 个问题     |
|                  |                  |         | 3       |     | 点击  | 批量修改              |                        |
|                  |                  |         | 4       |     | 点击  | 标记为不会修复         |                   |
|                  |                  |         | 5       |     | 输入  | 评论                  | 历史遗留问题，不做修复    |
|                  |                  |         | 6       |     | 点击  | 应用                  |                         |
|                  |                  |         | 7       |     | 检查  | 批量修改              | 批量修改, #wait=8       |
| `loop_notfix`    | 循环执行notfix    |         | 1       |     | 执行  | notfix*10000         |                        |	

执行以上用例，即可循环执行批量修改任务，我也可以喝喝茶休息一下了~

### 3. 优化元素定位

上面我们对元素的定义时直接复制 F12 的 xpath，这种方法在开发不断变化的情况下，是很容易失效的，所以，我们需要做一些优化。

- 登录按钮

其实，登录按钮是一个 button，文本是“登录”，我们可以直接使用 `button#登录`变量定位法，而不需要在元素列表中单独定义。

- 问题页

我们可以看到，问题页是导航栏的一项，我们可以为导航栏定制一个通用的变量定位法，即：

| app       | element     | value                                                 | by                |
|-----------|-------------|-------------------------------------------------------|-------------------|
|           | 导航#        | //*[@id="global-navigation"]//a[text()="#"]          | xpath             |
|           | 问题类别#    | //a[@data-facet="#"]                                  | xpath             |

用例中的元素只需写`导航#问题`即可，通用，异味也可以定制一个通用的变量定位法，如上表中的`问题类别#`

最终，我们得到如下的元素列表（省略了部分元素）：

| app       | element     | value                                                 | by                |
|-----------|-------------|-------------------------------------------------------|-------------------|
| public    | title       |                                                       | title             |
|           | id#         | #                                                     | id                |
|           | xpath#      | #                                                     | xpath             |
|           | url#        | #                                                     | url               |
|           | button#     | //button[text()="#"]                                  | xpath             |
| SonarQube | module      | web                                                   |                   |
|           | setting     | {'browserName': 'Chrome','headless': False}           | json              |
|           | 导航#        | //*[@id="global-navigation"]//a[text()="#"]          | xpath             |
|           | 问题类别#    | //a[@data-facet="#"]                                  | xpath             |


### 4. 优化执行逻辑

在第2节的用例中，我们是顺序执行用例，但没有考虑到用例执行容错问题，假如某次批量修改出错，则可能后续用例都无法执行。

在 Sweet 中，一般建议使用 `SETUP` 来确保测试用例执行前置条件，前提条件一般是进入到某个特定页面，这里批量修改的前提条件就是进入问题页的异味选项页。

即测试用例的步骤3和步骤4，我们把这2步拆分为单独用例 smell_001，前置条件设为：SETUP

但进入问题页也有前提条件，就是需要先登录，一般对于需要登录的用例，我们建议把登录操作放在 BASE 里。这样登录操作只需要执行一次即可。

根据 BASE 的语法说明，如果 SETUP 执行失败，会再次执行 BASE，但登录后的页面，是无需再次登录，也没有登录框和登录按钮的，所以，为避免此种情况，我们在登录操作中，需要加一个判断，检查是否有登录按钮，如下表中步骤2，只有当有登录按钮时，才进行登录操作。

同理，对于批量修改操作，只有批量修改按钮文字变为：“批量修改 500 个问题”时，我们才进行后续的修改操作，如下表中步骤2~7

最终，测试用例如下：

|用例编号           | 用例标题         | 前置条件 | 测试步骤 | 应用  | 操作  | 元素          | 测试数据                |
| ---------------- | ---------------- | ------- | -------- | ---- | ---- | ------------- | ---------------------- |
|home_001          | 登录SonarQube    | BASE    | 1        |      | 打开  | `url#sonarqube.io` | #tab=SonarQube    |
|                  |                  |         | ^2       |      | 检查  | button#登录   |                        |                  |                  |                  |         | >3       |      | 输入  | id#login     | admin                  |
|                  |                  |         | >4       |      | 输入  | id#password  | 123456                 |
|                  |                  |         | >5       |      | 点击  | button#登录  |                        |
|smell_001         | 进入异味问题页面  | SETUP   | 1        |      | 点击  | 导航#问题     |                        |
|                  |                  |         | 2        |      | 点击  | 问题类别#CODE_SMELL |                  |
| notfix#change_001 | 批量修改为不会修复 |        | 1         |      | 点击 | 选择所有问题   |                        |
|                  |                  |         | ^2       |      | 检查  | 批量修改      | 批量修改 500 个问题     |
|                  |                  |         | >3       |      | 点击  | 批量修改      |                        |
|                  |                  |         | >4       |      | 点击  | 转移#标记为不会修复 |                   |
|                  |                  |         | >5       |      | 输入  | 评论         | 历史遗留问题，不做修复    |
|                  |                  |         | >6       |      | 点击  | 应用         |                         |
|                  |                  |         | >7       |      | 检查  | 批量修改      | 批量修改, #wait=8       |
| `loop_notfix`    | 循环执行notfix    |         | 1       |     | 执行  | notfix*10000         |                        |	